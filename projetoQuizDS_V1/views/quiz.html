<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quiz Educacional</title>
  <link href="https://fonts.googleapis.com/css2?family=Momo+Trust+Display&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/quiz.css">
</head>
<body>
  <header class="navbar">
    <div class="logo-container">
      <div class="logo">Quiz Interativo</div>
    </div>
    <nav>
      <a href="/" class="linkT">InÃ­cio</a>
      <a href="/disciplinaEcurso" class="linkT">Disciplinas</a>
    </nav>
  </header>

  <div class="quiz-container">
    <div class="quiz-header">
      <h1>Quiz de Desenvolvimento de Sistemas</h1>
      <div class="disciplina-nome" id="disciplinaNome">Carregando...</div>
    </div>

    <div id="loadingContainer" class="loading">
      Carregando questÃµes...
    </div>

    <div id="quizContent" style="display: none;">
      <div id="questoesContainer"></div>

      <div class="botoes-container">
        <button class="btn btn-proximo" id="btnProximo" onclick="proximaQuestao()" disabled>
          PrÃ³xima
        </button>
      </div>
    </div>

    <div id="resultadoContainer" class="resultado-container">
      <h2>Quiz Finalizado! ðŸŽ‰</h2>
      <div class="pontuacao-final" id="pontuacaoFinal">0/0</div>
      <div class="mensagem-resultado" id="mensagemResultado"></div>
      <button class="btn btn-reiniciar" onclick="reiniciarQuiz()">Tentar Novamente</button>
      <button class="btn btn-reiniciar" onclick="voltarDisciplinas()">Escolher Outra Disciplina</button>
    </div>
  </div>

  <script>

    let questoes = [];
    let questaoAtual = 0;
    let respostas = [];
    let pontuacao = 0;
    let disciplinaId = null;
    let alternativas = []

    function obterDisciplinaDaURL() {
      const params = new URLSearchParams(window.location.search);
      return params.get('disciplina');
    }

    async function carregarQuestoes() {
      disciplinaId = obterDisciplinaDaURL();
      
      if (!disciplinaId) {
        mostrarErro('Disciplina nÃ£o selecionada. Por favor, selecione uma disciplina.');
        return;
      }

      fetch("/api/disciplina/" + disciplinaId, {
        method: "GET",
        headers: {
          "content-Type": "application/json",
          "bearer": localStorage.getItem("token")
        }
      })
        .then(response => response.json())
        .then(result => {
          document.getElementById('disciplinaNome').textContent = result.nome
        })
        .catch(err => console.error(err))

      try {
        questoes = await gerarQuestoesExemplo(disciplinaId);
        
        if (questoes.length === 0) {
          mostrarErro('Nenhuma questÃ£o encontrada para esta disciplina.');
          return;
        }

        iniciarQuiz();
      } catch (error) {
        mostrarErro('Erro ao carregar questÃµes: ' + error.message);
      }
    }

    async function gerarQuestoesExemplo(disciplinaId) {
      try {
        const response = await fetch("/api/questaoByDisciplinaId/" + disciplinaId, {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            "bearer": localStorage.getItem("token")
          }
        });
        const questoes = await response.json();
        return questoes;
      } catch (err) {
        console.error(err);
        return [];
      }
    }

    function mostrarErro(mensagem) {
      document.getElementById('loadingContainer').style.display = 'none';
      document.getElementById('erroContainer').textContent = mensagem;
      document.getElementById('erroContainer').style.display = 'block';
    }

    function iniciarQuiz() {
      document.getElementById('loadingContainer').style.display = 'none';
      document.getElementById('quizContent').style.display = 'block';
      respostas = new Array(questoes.length).fill(null);
      exibirQuestao();
    }

    function exibirQuestao() {
      const container = document.getElementById('questoesContainer');
      container.innerHTML = '';

      questoes.forEach((questao, index) => {
        const questaoDiv = document.createElement('div');
        questaoDiv.className = 'questao-container' + (index !== questaoAtual ? ' escondida' : '');
        questaoDiv.id = `questao-${index}`;

        const letras = ['A', 'B', 'C', 'D', 'E', 'F'];

        questaoDiv.innerHTML = `
          <div class="question-box">
            <img src="img/robo.png" alt="Ã­cone pergunta" class="question-icon" onerror="this.style.display='none'">
            <div class="questao-numero">QuestÃ£o ${index + 1} de ${questoes.length}</div>
            <div class="questao-enunciado">${questao.questaoEnunciado}</div>
          </div>
          <div class="alternativas" id="alternativas-${index}">
            ${questao.alternativas.map((alt, altIndex) => `
              <div class="alternativa" onclick="selecionarAlternativa(${index}, ${alt.id})">
                <span class="letra-opcao">${letras[altIndex]}</span>
                <input type="radio" name="questao-${index}" id="alt-${alt.id}" value="${alt.id}">
                <label for="alt-${alt.id}">${alt.enunciado}</label>
              </div>
            `).join('')}
          </div>
        `;

        container.appendChild(questaoDiv);
      });

      atualizarBotaoProximo();
    }

    function selecionarAlternativa(questaoIndex, alternativaId) {
      const alternativasDiv = document.getElementById(`alternativas-${questaoIndex}`);
      alternativasDiv.querySelectorAll('.alternativa').forEach(alt => {
        alt.classList.remove('selecionada');
      });


      const alternativaClicada = alternativasDiv.querySelector(`#alt-${alternativaId}`).closest('.alternativa');
      alternativaClicada.classList.add('selecionada');

      document.getElementById(`alt-${alternativaId}`).checked = true;

      respostas[questaoIndex] = alternativaId;

      atualizarBotaoProximo();
    }

    function atualizarBotaoProximo() {
      const btn = document.getElementById('btnProximo');
      btn.disabled = respostas[questaoAtual] === null;
      
      if (questaoAtual === questoes.length - 1) {
        btn.textContent = 'Finalizar Quiz';
      } else {
        btn.textContent = 'PrÃ³xima â†’';
      }
    }

    function proximaQuestao() {
      if (questaoAtual < questoes.length - 1) {
        questaoAtual++;
        exibirQuestao();
      } else {
        finalizarQuiz();
      }
    }

    function finalizarQuiz() {
      pontuacao = 0;
      questoes.forEach((questao, index) => {
        alternativas.push(respostas[index])
        const respostaSelecionada = respostas[index];
        const alternativaCorreta = questao.alternativas.find(alt => alt.correta === 1);
        
        if (respostaSelecionada === alternativaCorreta.id) {
          pontuacao += questao.questaoPontuacao;
        }
      });

      document.getElementById('quizContent').style.display = 'none';
      document.getElementById('resultadoContainer').classList.add('ativo');
      
      const pontuacaoMaxima = questoes.reduce((sum, q) => sum + q.questaoPontuacao, 0);
      document.getElementById('pontuacaoFinal').textContent = `${pontuacao}/${pontuacaoMaxima}`;
      
      const percentual = (pontuacao / pontuacaoMaxima) * 100;
      let mensagem = '';
      
      if (percentual === 100) {
        mensagem = 'Perfeito! VocÃª acertou todas! ðŸŒŸ';
      } else if (percentual >= 80) {
        mensagem = 'Excelente! Muito bem! ðŸŽ¯';
      } else if (percentual >= 60) {
        mensagem = 'Bom trabalho! Continue estudando! ðŸ“š';
      } else {
        mensagem = 'Continue praticando! VocÃª vai melhorar! ðŸ’ª';
      }
      
      document.getElementById('mensagemResultado').textContent = mensagem;

      fetch("/api/pontuar",{
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "bearer": localStorage.getItem("token")
          },
        body:JSON.stringify({
          alternativasId: alternativas 
        })

      })
    }

    function reiniciarQuiz() {
      questaoAtual = 0;
      respostas = new Array(questoes.length).fill(null);
      pontuacao = 0;
      document.getElementById('resultadoContainer').classList.remove('ativo');
      document.getElementById('quizContent').style.display = 'block';
      exibirQuestao();
    }

    function voltarDisciplinas() {
      window.location.href = 'disciplinaEcurso.html';
    }

    window.addEventListener('DOMContentLoaded', carregarQuestoes);
  </script>
</body>
</html>
